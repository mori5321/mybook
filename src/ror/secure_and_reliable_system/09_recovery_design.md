# リカバリを想定した設計
## Overview
- rate制限
- version番号管理
- ロールバックや失効のトレードオフ

## リカバリが必要となる状況
### 1. ランダムエラー
物理デバイスの信頼性の低さ・予測不可能な状況から発生するもの

- 電源やルータなどのシステムの一部分の故障や遮断(この中では最もeasy)
- ビットフリップ(ハードウェアの故障他システムからのノイズや宇宙線よっておきる)
- 竜巻や自信

### 2. 偶発的なエラー
- 運用する人間が引き起こすエラー
- 全員の人間が引き起こすエラー

### 3. ソフトウェアのエラー


### 4. 悪意のあるアクション

## リカバリを想定した設計原則
発生する可能性がある問題の幅や多様性に関して先入観を持たないことが大切。
言い換えるとエラーの微妙なエッジケースをどう分類するかで悩むことに時間を費やすのではなく、そこからリカバリする準備に集中しなければなりません。

### 可能な限り迅速に対応するための設計
「緊急時のプラクティスはテストしなければいざというときに機能しない」
=> 通常時のシステムが緊急時の処理にも利用可能なようにする(通常時のものを性能を最大限発揮できるようにするだけ)。

### 外部の時間概念に対する依存度の制限
イベントを実時間と紐づけるのは多くの場合でアンチパターンとなる。

e.g. デジタル署名されたトランザクションの再実行を伴うリカバリ。署名が失効していたらどうする...? リカバリプロセスつくるの大変じゃない? 
=> リカバリ実行のために一時的に証明書チェックを無効にしたくなるかもしれないが、それは脆弱性。

実時間ではなく、以下を使うのがオススメ
- レート
- バージョン番号のような手動で進めることができる進行の概念
- 有効性リスト

ex: 有効激減ではなく失効リストを持つ

=> JWTの弱点とも言えるよな。


### セキュリティと信頼性のトレードオフであるロールバック
ロールバックを防止する必要があるケースがあるよね。

任意のロールバックを許可する
=> 攻撃者としては武器として悪用しやすい

いかなるロールバックも許可しない
=> 信頼性が担保できない

実用的なトレードオフ
- 拒否リストの使用
    - 不良バージョンのリストアップ
    - 巨費リスト自体をハックされてしまう
- セキュリティ番号(SVN)
- 最小許容セキュリティバージョン番号(MASVN)
    - 個々のリリースバージョンに、リリース時点で受入可能なバージョンが反映されたMASVN値を含める
- 署名鍵のローテーション


## 明示的な失効の仕組みの利用
積極的な侵害に直面した場合には、失効システムが救世主となる。
攻撃者に制御されたクレデンシャルをすみやかに失効させてシステムの制御を取り戻せる可能性がある。


## クレデンシャルの大規模な失効
=> いざというときこの判断に素早く踏み切るの難しいよなぁ。事前にこの手札を吟味していないと。

## リスクが高い例外の回避


## ミュータビリティをへらすこと
ミュータビリティを減らすこと
すなわち、デプロイされた状態を読み取りやすいこと
すなわち、システムの意図した状態を即座に理解しやすいこと
すなわち、システムを既知の良好な状態に戻す難易度を下げること

## 

悪意のあるインサイダーはバックアップと称して破損したバックアップからのリストアを強行するかもしれません。
バックアップに協力な暗号署名をつけているとしても、リストアに用いるツールが署名を検証しなければ、あるいは署名を手動で作成できる人間を適切に制限しなければ
こうしたショミも役に立たない。

バックアップのコンパートメント化?

## 削除について
データリカバリシステムでは必ず、削除されたはずのデータを誤ってリストアできないようにします。
暗号鍵の削除と暗号化されたデータの削除の違いを意識してください。

暗号化削除は効率的だが、
暗号化削除で、この要件を満たそうとすると

細かく鍵をコンパートメント化する必要がでてきてしまう。

## テストと継続的な検証を促進する設計
Googleの暗号鍵管理プロトコルのケース
E2Eテストに多大な投資を行ったとしても、ハードウェアの障害や通信の遮断を完全にエミュレートするのは不可能なケース。
どうしたか? 

- コアロジックをDRYに1つだけ作成
- 徹底的なUnitテスト
- コンポーネント境界のI/Fを慎重に設計
- 個別コンポーネントをぎすして、障害動作を再現するために プリミティブなインターフェイスの作成
    - フラッシュメモリとの間のバイトの読み書き
    - 暗号鍵の保存
    - etc ...`

## 緊急アクセス
通常のアクセス方法が完全に機能しなくなった場合にデプロイするための、特殊目的のソリューション。

サードパーティプロバイダについて
- 依存関係が提供しうるものの総和としての可用性しか得られないことを意識しておくべき

## アクセス制御

